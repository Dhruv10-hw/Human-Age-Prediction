USE DATABASE AGEPREDICTION;
USE SCHEMA PUBLIC;
CREATE OR REPLACE VIEW AGE_MODEL_ANALYSIS AS
SELECT
    t.PERSON_ID,
    t.GENDER,
    t.EDUCATION_LEVEL,
    t.INCOME_LEVEL,
    t.SMOKING_STATUS,
    t.ALCOHOL_CONSUMPTION,
    t.PHYSICAL_ACTIVITY_LEVEL,
    t.STRESS_LEVELS,
    t."Age (years)" AS ACTUAL_AGE,
    m.PREDICTED_AGE,
    (m.PREDICTED_AGE - t."Age (years)") AS AGE_GAP,
    ABS(m.PREDICTED_AGE - t."Age (years)") AS ABS_ERROR
FROM TRAIN_DATA t
JOIN MODEL_OUTPUT m
ON t.PERSON_ID = m.PERSON_ID;
SELECT 
    COUNT(*) AS TOTAL_RECORDS,
    ROUND(AVG(ABS_ERROR),2) AS MAE,
    ROUND(AVG(AGE_GAP),2) AS AVG_BIAS,
    ROUND(MAX(ABS_ERROR),2) AS MAX_ERROR
FROM AGE_MODEL_ANALYSIS;
SELECT 
    ROUND(CORR(ACTUAL_AGE, PREDICTED_AGE),3) AS MODEL_CORRELATION
FROM AGE_MODEL_ANALYSIS;
SELECT 
    SMOKING_STATUS,
    ROUND(AVG(ABS_ERROR),2) AS AVG_ERROR
FROM AGE_MODEL_ANALYSIS
GROUP BY SMOKING_STATUS
ORDER BY AVG_ERROR DESC;
SELECT 
    GENDER,
    ROUND(AVG(ABS_ERROR),2) AS AVG_ERROR
FROM AGE_MODEL_ANALYSIS
GROUP BY GENDER
ORDER BY AVG_ERROR DESC;
SELECT 
    EDUCATION_LEVEL,
    ROUND(AVG(ABS_ERROR),2) AS AVG_ERROR
FROM AGE_MODEL_ANALYSIS
GROUP BY EDUCATION_LEVEL
ORDER BY AVG_ERROR DESC;
CREATE OR REPLACE VIEW AGE_MODEL_ACCURACY_BUCKETS AS
SELECT
    *,
    CASE 
        WHEN ABS_ERROR < 3 THEN 'High Accuracy'
        WHEN ABS_ERROR < 7 THEN 'Medium Accuracy'
        ELSE 'Low Accuracy'
    END AS ACCURACY_BUCKET
FROM AGE_MODEL_ANALYSIS;
SELECT 
    ACCURACY_BUCKET,
    COUNT(*) AS RECORD_COUNT,
    ROUND(AVG(ABS_ERROR),2) AS AVG_ERROR
FROM AGE_MODEL_ACCURACY_BUCKETS
GROUP BY ACCURACY_BUCKET
ORDER BY RECORD_COUNT DESC;
SELECT 
    PERSON_ID,
    ACTUAL_AGE,
    PREDICTED_AGE,
    ABS_ERROR
FROM AGE_MODEL_ANALYSIS
ORDER BY ABS_ERROR DESC
LIMIT 10;
SELECT
    CASE 
        WHEN AGE_GAP > 0 THEN 'Overpredicted'
        WHEN AGE_GAP < 0 THEN 'Underpredicted'
        ELSE 'Exact'
    END AS PREDICTION_TYPE,
    COUNT(*) AS COUNT_RECORDS
FROM AGE_MODEL_ANALYSIS
GROUP BY PREDICTION_TYPE;
SELECT *
FROM AGE_MODEL_ANALYSIS;
CREATE OR REPLACE VIEW SEGMENT_ERROR_ANALYSIS AS
SELECT
    GENDER,
    SMOKING_STATUS,
    EDUCATION_LEVEL,
    AVG(ABS_ERROR) AS AVG_ERROR,
    COUNT(*) AS RECORD_COUNT
FROM AGE_MODEL_ANALYSIS
GROUP BY GENDER, SMOKING_STATUS, EDUCATION_LEVEL;
SELECT COUNT(*) 
FROM TRAIN_DATA
WHERE PERSON_ID IS NULL;
SELECT *
FROM SEGMENT_ERROR_ANALYSIS;
